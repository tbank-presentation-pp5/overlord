name: Backend CI/CDL Pipeline

on:
  push:
    branches: [ "main", "master" ]
  pull_request:
    branches: [ "main", "master" ]

env:
  POSTGRES_DB: overlord
  POSTGRES_USER: user
  POSTGRES_PASSWORD: password
  MINIO_ROOT_USER: minioadmin
  MINIO_ROOT_PASSWORD: minioadmin123

jobs:
  build-and-ci:
    name: Build and Unit Tests
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 25
        uses: actions/setup-java@v4
        with:
          java-version: '25-ea'
          distribution: 'temurin'
          cache: 'maven'

      - name: Maven build
        run: mvn clean package -DskipTests=false

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: overlord-jar
          path: target/*.jar
          retention-days: 1

  cdl-checks:
    name: Integration and Smoke Tests
    needs: build-and-ci
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup JDK 25
        uses: actions/setup-java@v4
        with:
          java-version: '25-ea'
          distribution: 'temurin'
          cache: 'maven'

      - name: Download Build Artifact
        uses: actions/download-artifact@v4
        with:
          name: overlord-jar
          path: target/

      - name: Start Infrastructure (Postgres, MinIO)
        run: docker compose up -d postgres minio minio-init

      - name: Readiness probe
        run: |
          echo "Waiting for Postgres..."
          until docker exec $(docker compose ps -q postgres) pg_isready -U $POSTGRES_USER; do
            sleep 2
          done
          echo "Postgres is ready!"
          sleep 5 # MinIO init

      - name: Run Integration Tests
        run: mvn verify -Dskip.unit.tests=true

      - name: Build App Image
        run: |
          docker compose build app
          docker compose up -d app

      - name: smoke-tests
        run: |
          echo "Waiting for Spring Boot..."
          timeout=60
          url="http://localhost:8080/"
          while [ $timeout -gt 0 ]; do
            status_code=$(curl --write-out %{http_code} --silent --output /dev/null $url || echo "000")
            if [ "$status_code" -eq 200 ]; then
              echo "Application is UP!"
              exit 0
            fi
            echo "Waiting... ($timeout)"
            sleep 2
            ((timeout-=2))
          done
          echo "App did not start"
          docker compose logs app
          exit 1

      - name: Stop Containers
        if: always()
        run: docker compose down

  lint:
    name: Code Quality Checks (Non-Blocking)
    runs-on: ubuntu-latest
    continue-on-error: true
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '25'
          cache: 'maven'

      - name: Run Static Analysis
        run: >
          mvn compile 
          checkstyle:check 
          pmd:check 
          com.github.spotbugs:spotbugs-maven-plugin:check
          -Dmaven.test.skip=true 
          -B

      - name: Upload Quality Reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: code-quality-reports
          path: |
            target/checkstyle-result.xml
            target/site/checkstyle.html
            target/pmd.xml
            target/spotbugsXml.xml
          if-no-files-found: ignore

  security-check:
    name: OWASP Dependency Check
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: set up JDK
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '25'
          cache: 'maven'

      - name: Run OWASP Dependency Check
        run: mvn org.owasp:dependency-check-maven:check -Dformat=XML -Dmaven.test.skip=true

      - name: Upload Dependency Check Report
        uses: actions/upload-artifact@v4
        with:
          name: security-reports
          path: |
            target/dependency-check-report.xml
            target/dependency-check-report.html
          if-no-files-found: ignore
